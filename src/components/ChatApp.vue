<style>
.chat-btn{
 z-index: 99;
 margin-bottom:100px !important;
}
.top-r {
 text-align: -webkit-right;
}
</style>

<template>

<div>
    <v-dialog v-model="dialog" width="500">
        <template v-slot:activator="{ on, attrs }">
            <v-btn
            color="lime darken-5"
            dark rounded
            v-bind="attrs"
            v-on="on"
            class="chat-btn"
            fixed bottom right
            >
              <v-icon
              fab dark
              v-bind="attrs"
              v-on="on">
                mdi-chat
              </v-icon>
        </v-btn>
        </template>
        <v-card class="my-0 left">
          <div class="top-r">
              <v-btn class="form-close-btn"  @click="dialog = false" width="5px">
                  <v-icon>
                      mdi-close
                  </v-icon>
              </v-btn>
          </div>
            <div id="chat" class="container">
              <v-card  padding="10px" class="pa-3 m-tb-20 form-group">
                <h4>Welcome</h4>
                <p>Hello, can we help you with something? </p>
              </v-card>

              <!-- Messages -->
              <div v-bind:key="message" v-for="message in messages" class="card">
                <v-card padding="10px" class="pt-3 m-tb-20">

                  <!-- nickname -->
                  <h4 class="card-subtitle mb-2 ml-3 text-muted">{{ message.nickname }}</h4>
                  <!-- content -->
                  <p v-if="message !== editingMessage" class="card-text ml-3 ">{{ message.text }}</p>
                  <v-textarea v-else v-model="messageText" class="form-control"></v-textarea>
                  <!-- actions -->
                  <div v-if="message !== editingMessage">
                    <v-divider></v-divider>
                    <a @click.prevent="deleteMessage(message)" href="#" class="card-link"><v-icon color=red>mdi-delete</v-icon></a>
                    <a @click.prevent="editMessage(message)" href="#" class="card-link"><v-icon color=orange>mdi-pencil</v-icon></a>
                  </div>
                  <div v-else>

                    <a @click.prevent="cancelEditing" href="#" class="card-link"><v-icon color=red>mdi-cancel</v-icon></a>
                    <a @click.prevent="updateMessage" href="#" class="card-link"><v-icon color=green>mdi-pencil</v-icon></a>
                  </div>
                </v-card>
              </div>

              <!-- New Message -->
            <v-card hover  class="m-tb-20 pl-3 pr-3">
              <form  v-if="!editingMessage" @submit.prevent="storeMessage">
                <div class="form-group">
                  <h4>Chat App Demo</h4>
                  <v-textarea label="Message" v-model="messageText" class="form-control"></v-textarea>
                </div>
                <div class="form-group">
                  <v-text-field label="Nickname" placeholder="Enter Nickname" type="input" v-model="nickname" class="form-control">
                  </v-text-field>
                </div>
                <v-btn type="submit" class="m-tb-20 btn btn-primary"><v-icon color=primary>mdi-send</v-icon></v-btn>
              </form>
            </v-card>
            </div>
        </v-card>
    </v-dialog>
</div>
</template>

<script>
import nativeToast from 'native-toast'
import firebase from '../plugins/firebase'

//puts app name
//console.log(firebase.name);
//puts db reference
//console.log(firebase.database());

let db = firebase.database();
let messagesRef = db.ref('support-chat');
//line beneath gets us a console log of our db ref value to analize
db.ref('support-chat')/*,.on('value' snapshot => console.log(snapshot.val()));*/


export default {
    name: 'ChatApp',
    data() {
        return {
            dialog: false, // this for modal
            messages: [],
            messageText: '',
            nickname: '',
            editingMessage: null
        }
    },
    methods: {
        storeMessage() {
                messagesRef.push({
                    text: this.messageText,
                    nickname: this.nickname
                })
                this.messageText = ''
            },
            deleteMessage(message) {
                messagesRef.child(message.id).remove()
            },
            editMessage(message) {
                this.editingMessage = message
                this.messageText = message.text
            },
            cancelEditing() {
                this.editingMessage = null
                this.messageText = ''
            },
            updateMessage() {
                messagesRef.child(this.editingMessage.id).update({
                    text: this.messageText
                })
                this.cancelEditing()
            }
    },

    created() {
        // value = snapshot.val() | key = snapshot.key
        messagesRef.on('child_added', snapshot => {
            this.messages.push({...snapshot.val(), id: snapshot.key
            })
            if (snapshot.val().nickname !== this.nickname) {
                nativeToast({
                    message: `New message by ${snapshot.val().nickname}`,
                    type: 'success'
                })
            }
        })
        messagesRef.on('child_removed', snapshot => {
            const deletedMessage = this.messages.find(message => message.id === snapshot.key)
            const index = this.messages.indexOf(deletedMessage)
            this.messages.splice(index, 1)
            if (snapshot.val().nickname !== this.nickname) {
                nativeToast({
                    message: `Message deleted by ${snapshot.val().nickname}`,
                    type: 'warning'
                })
            }
        })
        messagesRef.on('child_changed', snapshot => {
            const updatedMessage = this.messages.find(message => message.id === snapshot.key)
            updatedMessage.text = snapshot.val().text
            if (snapshot.val().nickname !== this.nickname) {
                nativeToast({
                    message: `Message edited by ${snapshot.val().nickname}`,
                    type: 'info'
                })
            }
        })
    },
  }

</script>
